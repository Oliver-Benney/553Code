<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoseDoodle</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        video {
            padding-top: 100px;
            position: absolute;
            transform: scale(-1, 1);
        }

        main {
            position: absolute;
            z-index: 100;
        }

    </style>
</head>
<body>
     
      <div class="title">
          <h1>PoseDoodle</h1>
      </div>
      
      <div class="frame">
        
      </div>

      <div class="video">
        <div id="holder"></div>
      </div>

    <div id="MAIN">
      <div class="screen">
        <div id="tips">
          <div class="toolTips">
            Tooltips - Say...
          </div>
        </div>
      </div>
    </div>

    <p id = "status">Loading...</p>
    <script src="https://unpkg.com/p5"></script>
    <script src="https://unpkg.com/ml5"></script>
    <script src="https://cdn.jsdelivr.net/gh/IDMNYU/p5.js-speech@0.0.3/lib/p5.speech.js"></script>
    <script>
        let video;
        let poseNet;
        let poses = [];
        let leftWristX, leftWristY;
        let rightWristX, rightWristY;
        let fireworks = [];
        let m = 1;
        let sa = 1;
        let r;
        let g;
        let b;

        function setup() {
            canvas = createCanvas(683, 483);
            video = createCapture(VIDEO);
            video.parent('holder');
            video.size(width, height);
            //video.hide();

            noLoop();
            r = 0;
            g = 0;
            b = 0;
            frameRate(17);

            leftWristX = width/2;
            leftWristY = height/2;
            rightWristX = width/2;
            rightWristY = height/2;

            poseNet = ml5.poseNet(video, modelReady);
            poseNet.on('pose', results => {
            poses = results;});
            
            let SpeechRec = new p5.SpeechRec('en-US', gotSpeech);
            let continuous = true;
            let interim = false;
            SpeechRec.start(continuous, interim);

            function gotSpeech() {
              if (SpeechRec.resultValue) {
                    var mostrecentword = SpeechRec.resultString

                    //Punctuation to remove 
                    let regex = /[.,\/#!$%\^&\*;:{}=\-_`~()]/g;
                    //Replace punctuation with nothing and force lower case
                    mostrecentword = mostrecentword.replace(regex, "").toLowerCase();
                
                //Toggle drawing
		            if(mostrecentword.indexOf("draw")!==-1) {loop();}
		            else if(mostrecentword.indexOf("stop")!==-1) {noLoop();}

                //Clear canvas
                else if(mostrecentword.indexOf("clear canvas")!==-1) {clear();}

                //Toggle video
                else if(mostrecentword.indexOf("show video")!==-1) {video.show();}
                else if(mostrecentword.indexOf("hide video")!==-1) {video.hide();}

                //Types of pens
                else if(mostrecentword.indexOf("circles")!==-1) {m = 1}
                else if(mostrecentword.indexOf("fireworks")!==-1) {m = -1;}

                //Toggle tips
                else if(mostrecentword.indexOf("hide tips")!==-1) {var tips = document.getElementById("tips");
                                                                   tips.style.display = "none";}
                else if(mostrecentword.indexOf("show tips")!==-1) {var tips = document.getElementById("tips");
                                                                   tips.style.display = "contents";}
                
                //Saving image
                else if(mostrecentword.indexOf("save")!==-1) {save('doodle.png');}

                //Colors
                else if(mostrecentword.indexOf("red")!==-1) {r = 255, g = 0, b = 0;}
                else if(mostrecentword.indexOf("green")!==-1) {r = 0, g = 255, b = 0;}
                else if(mostrecentword.indexOf("blue")!==-1) {r = 0, g = 0, b = 255;}
                else if(mostrecentword.indexOf("black")!==-1) {r = 0, g = 0, b = 0;}
                else if(mostrecentword.indexOf("white")!==-1) {r = 255, g = 255, b = 255;}
                else if(mostrecentword.indexOf("yellow")!==-1) {r = 255, g = 255, b = 0;}
                else if(mostrecentword.indexOf("pink")!==-1) {r = 255, g = 51, b = 153;}
                else if(mostrecentword.indexOf("grey")!==-1) {r = 128, g = 128, b = 128;}
                else if(mostrecentword.indexOf("orange")!==-1) {r = 255, g = 153, b = 51;}
                else if(mostrecentword.indexOf("brown")!==-1) {r = 153, g = 76, b = 0;}
                else if(mostrecentword.indexOf("purple")!==-1) {r = 153, g = 0, b = 153;}

                //Single arm or both arms
                else if(mostrecentword.indexOf("both arms")!==-1) {sa = 0;}
                else if(mostrecentword.indexOf("one arm")!==-1) {sa = 1;}

		            console.log(mostrecentword);
                }
                console.log(SpeechRec);
            }
        }

        function draw() {
            translate(width, 0);
            scale(-1,1);

            if (poses.length > 0 && m === -1) {
                drawleftWrist(poses[0].pose);
                drawrightWrist(poses[0].pose);
            } 
            else if (poses.length > 0 && m === 1) {
              drawleftCircle(poses[0].pose);
              drawrightCircle(poses[0].pose);
            }

            for (let i = 0; i < fireworks.length; i++) {
                 fireworks[i].update();
                 fireworks[i].show();
            }

            console.log(poses);
        }

  class Firework {
    constructor(x, y) {
    this.x = x;
    this.y = y;
    this.vx = random(-3, 3);
    this.vy = random(-10, -5);
    this.gravity = 0.5;
    this.color = color(random(255), random(255), random(255));
    this.exploded = false;
    this.particles = [];
  }
  
  update() {
    if (!this.exploded) {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += this.gravity;
      
      // Stops firework at max height
      if (this.vy >= 0) {
        this.explode();
      }
    }
  }
  
  explode() {
    this.exploded = true;
  }
  
  show() {
    if (!this.exploded) {
      stroke(this.color,this.lifespan);
      strokeWeight(4);
      point(this.x, this.y);
    }
  }
}

        //Draw with fireworks
        function drawleftWrist(pose) {

            leftWristX += (pose.leftWrist.x - leftWristX) * 0.3;
            leftWristY += (pose.leftWrist.y - leftWristY) * 0.3;

            if (pose.leftWrist.y < pose.rightWrist.y && sa === 1) {
              fireworks.push(new Firework(leftWristX, leftWristY));
            }
            else if (sa === 0) {
              fireworks.push(new Firework(leftWristX, leftWristY));
            }
        }

        function drawrightWrist(pose) {

            rightWristX += (pose.rightWrist.x - rightWristX) * 0.3;
            rightWristY += (pose.rightWrist.y - rightWristY) * 0.3;

            if (pose.rightWrist.y < pose.leftWrist.y && sa === 1) {
              fireworks.push(new Firework(rightWristX, rightWristY));
            }
            else if (sa === 0) {
              fireworks.push(new Firework(rightWristX, rightWristY));
            }
        }

        //Draw with circles
        function drawleftCircle(pose) {

            leftWristX += (pose.leftWrist.x - leftWristX) * 0.3;
            leftWristY += (pose.leftWrist.y - leftWristY) * 0.3;

            if (pose.leftWrist.y < pose.rightWrist.y && sa === 1) {
              noStroke();
              fill(r, g, b);
              ellipse(leftWristX, leftWristY, 8);
              }
              else if (sa === 0) {
                noStroke();
                fill(r, g, b);
                ellipse(leftWristX, leftWristY, 8);
            }
        }

        function drawrightCircle(pose) {

            rightWristX += (pose.rightWrist.x - rightWristX) * 0.3;
            rightWristY += (pose.rightWrist.y - rightWristY) * 0.3;

            if (pose.rightWrist.y < pose.leftWrist.y && sa === 1) {
              noStroke();
              fill(r, g, b);
              ellipse(rightWristX, rightWristY, 8);
              }
              else if (sa === 0) {
                noStroke();
                fill(r, g, b);
                ellipse(rightWristX, rightWristY, 8);
            }
        }
      
        function modelReady() {
            select('#status').html('');
        }

    </script>
</body>
</html>