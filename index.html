<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoseDoodle</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        video {
            padding-top: 100px;
            position: absolute;
            transform: scale(-1, 1);
        }

        main {
            position: absolute;
            z-index: 100;
        }
    </style>
</head>
<body>
     
      <div class="title">
          <h1>PoseDoodle</h1>
      </div>

      <div class="video">
        <div id="holder"></div>
      </div>

    <div id="MAIN">
      <div class="screen">
        <div id="tips">
            <div class="toolTips">
              <div id = "wow">
                <div class="botharms">
              </div></div>
              <div id = "wow1">
                <div class="circles">
              </div></div>
              <div id = "wow2">
                <div class="clearcanvas">
              </div></div>
              <div id = "wow3">
                <div class="draw">
              </div></div>
              <div id = "wow4">
                <div class="eraser">
              </div></div>
              <div id = "wow5">
                <div class="fill">
              </div></div>
              <div id = "wow6">
                <div class="fireworks">
              </div></div>
              <div id = "wow7">
                <div class="hideshowtips">
              </div></div>
              <div id = "wow8">
                <div class="hideshowvideo">
              </div></div>
              <div id = "wow9">
                <div class="lowerraiseopacity">
              </div></div>
              <div id = "wow10">
                <div class="onearm">
              </div></div>
              </div>
            </div>
          </div> 
        </div>
      </div>
    </div>

    <div class="mostRecentWord">
        Most Recent Command: <input id="user_input"></input>
    </div>

    <script src="https://unpkg.com/p5"></script>
    <script src="https://unpkg.com/ml5"></script>
    <script src="https://cdn.jsdelivr.net/gh/IDMNYU/p5.js-speech@0.0.3/lib/p5.speech.js"></script>
    <script>
        let video;
        let poseNet;
        let poses = [];
        let leftWristX, leftWristY;
        let rightWristX, rightWristY;
        let fireworks = [];
        let m = 1;
        let sa = 1;
        let r;
        let g;
        let b;
        let s;
        let o;

        function setup() {
            canvas = createCanvas(683, 483);
            video = createCapture(VIDEO);
            video.parent('holder');
            video.size(width, height);
            //video.hide();

            noLoop();
            frameRate(17);
            r = 0;
            g = 0;
            b = 0;
            s = 12;
            o = 1000;

            var box = document.getElementById("wow");
            box.style.display = "none"; 
            var box1 = document.getElementById("wow1");
            box1.style.display = "none";
            var box2 = document.getElementById("wow7");
            box2.style.display = "none";
            var box3 = document.getElementById("wow3");
            box3.style.display = "none";
            var box4 = document.getElementById("wow4");
            box4.style.display = "none";
            var box5 = document.getElementById("wow5");
            box5.style.display = "none";
            var box6 = document.getElementById("wow6");
            box6.style.display = "none";
            var box7 = document.getElementById("wow2");
            box7.style.display = "none";
            var box8 = document.getElementById("wow8");
            box8.style.display = "none";
            var box9 = document.getElementById("wow9");
            box9.style.display = "none";
            var box10 = document.getElementById("wow10");
            box10.style.display = "none";
     
            leftWristX = width/2;
            leftWristY = height/2;
            rightWristX = width/2;
            rightWristY = height/2;

            poseNet = ml5.poseNet(video);
            poseNet.on('pose', results => {
            poses = results;});
            
            let SpeechRec = new p5.SpeechRec('en-US', gotSpeech);
            SpeechRec.continuous = false;
            SpeechRec.onError = restart; 
            SpeechRec.onEnd = restart;
            SpeechRec.interim = false;
            SpeechRec.start();

            function restart(){
	            SpeechRec.start();
            }

            //Old code
            /*let continuous = true;
            let interim = false;
            SpeechRec.start(continuous, interim); */

            function gotSpeech() {
              if (SpeechRec.resultValue) {
                    var mostrecentword = SpeechRec.resultString

                    //Punctuation to remove 
                    let regex = /[.,\/#!$%\^&\*;:{}=\-_`~()]/g;
                    //Replace punctuation with nothing and force lower case
                    mostrecentword = mostrecentword.replace(regex, "").toLowerCase();
                
                //Toggle drawing
		            if(mostrecentword.indexOf("draw")!==-1) {loop();}
		            else if(mostrecentword.indexOf("stop")!==-1) {noLoop();}

                //Clear canvas
                else if(mostrecentword.indexOf("clear canvas")!==-1) {clear();}
                else if(mostrecentword.indexOf("play canvas")!==-1) {clear();}
                else if(mostrecentword.indexOf("clare canvas")!==-1) {clear();}

                //Toggle video
                else if(mostrecentword.indexOf("show video")!==-1) {video.show();}
                else if(mostrecentword.indexOf("hide video")!==-1) {video.hide(); 
                                                                    //main
                                                                    box7.style.display = "contents";
                                                                    //rest 
                                                                    box.style.display = "none";
                                                                    box1.style.display = "none";
                                                                    box2.style.display = "none";
                                                                    box3.style.display = "none";
                                                                    box4.style.display = "none";
                                                                    box5.style.display = "none";
                                                                    box6.style.display = "none";
                                                                    box8.style.display = "none";
                                                                    box9.style.display = "none";
                                                                    box10.style.display = "none";}

                //Types of pens
                else if(mostrecentword.indexOf("circles")!==-1) {m = 1}
                else if(mostrecentword.indexOf("fireworks")!==-1) {m = -1;}
                else if(mostrecentword.indexOf("eraser")!==-1) {m = -2;}

                //Toggle tips
                else if(mostrecentword.indexOf("hide tips")!==-1) {var tips = document.getElementById("tips");
                                                                   tips.style.display = "none";}
                else if(mostrecentword.indexOf("show tips")!==-1) {var tips = document.getElementById("tips");
                                                                   tips.style.display = "contents";}
                
                //Saving image
                else if(mostrecentword.indexOf("save")!==-1) {save('doodle.png');}

                //Colors for circles
                else if(mostrecentword.indexOf("red")!==-1) {r = 255, g = 0, b = 0;}
                else if(mostrecentword.indexOf("green")!==-1) {r = 0, g = 255, b = 0;}
                else if(mostrecentword.indexOf("blue")!==-1) {r = 0, g = 0, b = 255;}
                else if(mostrecentword.indexOf("black")!==-1) {r = 0, g = 0, b = 0;}
                else if(mostrecentword.indexOf("white")!==-1) {r = 255, g = 255, b = 255;}
                else if(mostrecentword.indexOf("yellow")!==-1) {r = 255, g = 255, b = 0;}
                else if(mostrecentword.indexOf("pink")!==-1) {r = 255, g = 51, b = 153;}
                else if(mostrecentword.indexOf("grey")!==-1) {r = 128, g = 128, b = 128;}
                else if(mostrecentword.indexOf("orange")!==-1) {r = 255, g = 153, b = 51;}
                else if(mostrecentword.indexOf("brown")!==-1) {r = 153, g = 76, b = 0;}
                else if(mostrecentword.indexOf("purple")!==-1) {r = 153, g = 0, b = 153;}

                //Single arm or both arms
                else if(mostrecentword.indexOf("both arms")!==-1) {sa = 0;}
                else if(mostrecentword.indexOf("one arm")!==-1) {sa = 1;}

                //Fill 
                else if(mostrecentword.indexOf("fill")!==-1) {noErase(); fill(r, g, b, o); rect(0, 0, 683, 500);} 
                else if(mostrecentword.indexOf("phil")!==-1) {noErase(); fill(r, g, b, o); rect(0, 0, 683, 500);}
                else if(mostrecentword.indexOf("bill")!==-1) {noErase(); fill(r, g, b, o); rect(0, 0, 683, 500);}

                //Pen size
                else if(mostrecentword.indexOf("small")!==-1) {s = 6;}
                else if(mostrecentword.indexOf("medium")!==-1) {s = 12;}
                else if(mostrecentword.indexOf("large")!==-1) {s = 18;}

                //Opacity
                else if(mostrecentword.indexOf("lower opacity")!==-1) {o = 150;}
                else if(mostrecentword.indexOf("raise opacity")!==-1) {o = 1000;}
                else if(mostrecentword.indexOf("ray's opacity")!==-1) {o = 1000;}
              
		            console.log(mostrecentword);
                }
                console.log(SpeechRec);

                let user_input = select('#user_input')
                user_input.value(mostrecentword);
              }
        }

        function draw() {
            translate(660, 0);
            scale(-1,1);

            if (poses.length > 0 && m === -1) {
                drawleftWrist(poses[0].pose);
                drawrightWrist(poses[0].pose);
            } 
            else if (poses.length > 0 && m === 1) {
              drawleftCircle(poses[0].pose);
              drawrightCircle(poses[0].pose);
            }
            else if (poses.length > 0 && m === -2) {
              eraseLeft(poses[0].pose);
              eraseRight(poses[0].pose);
            }

            for (let i = 0; i < fireworks.length; i++) {
                 fireworks[i].update();
                 fireworks[i].show();
            }

            console.log(poses);
        }

  class Firework {
    constructor(x, y) {
    this.x = x;
    this.y = y;
    this.vx = random(-3, 3);
    this.vy = random(-10, -5);
    this.gravity = 0.5;
    this.color = color(random(255), random(255), random(255));
    this.exploded = false;
    this.particles = [];
  }
  
  update() {
    if (!this.exploded) {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += this.gravity;
      
      // Stops firework at max height
      if (this.vy >= 0) {
        this.explode();
      }
    }
  }
  
  explode() {
    this.exploded = true;
  }
  
  show() {
    if (!this.exploded) {
      stroke(this.color,this.lifespan);
      strokeWeight(4);
      point(this.x, this.y);
    }
  }
}

        //Draw with fireworks
        function drawleftWrist(pose) {

            leftWristX += (pose.leftWrist.x - leftWristX) * 0.3;
            leftWristY += (pose.leftWrist.y - leftWristY) * 0.3;

            if (pose.leftWrist.y < pose.rightWrist.y && sa === 1) {
              noErase();
              fireworks.push(new Firework(leftWristX, leftWristY));
            }
            else if (sa === 0) {
              noErase();
              fireworks.push(new Firework(leftWristX, leftWristY));
            }
        }

        function drawrightWrist(pose) {

            rightWristX += (pose.rightWrist.x - rightWristX) * 0.3;
            rightWristY += (pose.rightWrist.y - rightWristY) * 0.3;

            if (pose.rightWrist.y < pose.leftWrist.y && sa === 1) {
              noErase();
              fireworks.push(new Firework(rightWristX, rightWristY));
            }
            else if (sa === 0) {
              noErase();
              fireworks.push(new Firework(rightWristX, rightWristY));
            }
        }

        //Draw with circles
        function drawleftCircle(pose) {

            leftWristX += (pose.leftWrist.x - leftWristX) * 0.3;
            leftWristY += (pose.leftWrist.y - leftWristY) * 0.3;

            if (pose.leftWrist.y < pose.rightWrist.y && sa === 1) {
              noErase();
              noStroke();
              fill(r, g, b);
              ellipse(leftWristX, leftWristY, s);
              }
              else if (sa === 0) {
                noErase();
                noStroke();
                fill(r, g, b);
                ellipse(leftWristX, leftWristY, s);
            }
        }

        function drawrightCircle(pose) {

            rightWristX += (pose.rightWrist.x - rightWristX) * 0.3;
            rightWristY += (pose.rightWrist.y - rightWristY) * 0.3;

            if (pose.rightWrist.y < pose.leftWrist.y && sa === 1) {
              noErase();
              noStroke();
              fill(r, g, b);
              ellipse(rightWristX, rightWristY, s);
              }
              else if (sa === 0) {
                noErase();
                noStroke();
                fill(r, g, b);
                ellipse(rightWristX, rightWristY, s);
            }
        }

        //Eraser
        function eraseLeft(pose) {

            leftWristX += (pose.leftWrist.x - leftWristX) * 0.3;
            leftWristY += (pose.leftWrist.y - leftWristY) * 0.3;

            if (pose.leftWrist.y < pose.rightWrist.y && sa === 1) {
              erase();
              ellipse(leftWristX, leftWristY, s);
            }
            else if (sa === 0) {
              erase();
              ellipse(leftWristX, leftWristY, s);
            }
        }
        function eraseRight(pose) {

            rightWristX += (pose.rightWrist.x - rightWristX) * 0.3;
            rightWristY += (pose.rightWrist.y - rightWristY) * 0.3;

            if (pose.rightWrist.y < pose.leftWrist.y && sa === 1) {
              erase();
              ellipse(rightWristX, rightWristY, s);
            }
            else if (sa === 0) {
              erase();
              ellipse(rightWristX, rightWristY, s);
            }
        }

    </script>
</body>
</html>